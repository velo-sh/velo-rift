#!/bin/bash
# Velo Development Setup Script - Single Source of Truth
# Run this script once after cloning the repo to set up your development environment.
#
# Usage: ./setup-dev.sh

set -euo pipefail

echo "ðŸš€ Velo Development Setup"
echo "========================="
echo

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Check for required tools
check_tool() {
    if ! command -v "$1" &> /dev/null; then
        echo -e "${RED}âŒ $1 is required but not installed.${NC}"
        echo "   Install: $2"
        exit 1
    fi
    echo -e "${GREEN}âœ…${NC} $1 found"
}

echo "ðŸ“‹ Checking required tools..."
check_tool "cargo" "https://rustup.rs"
check_tool "uv" "curl -LsSf https://astral.sh/uv/install.sh | sh"

# Install Rust toolchain (version locked in rust-toolchain.toml)
echo
echo "ðŸ”§ Installing Rust toolchain..."
rustup show active-toolchain || rustup default stable
rustup component add clippy rustfmt llvm-tools-preview 2>/dev/null || true

# Install Linux cross-target for pre-commit checks (catches #[cfg(linux)] bugs on macOS)
echo "ðŸ§ Installing Linux cross-compilation target..."
rustup target add x86_64-unknown-linux-gnu

# Create Python venv and install deps from pyproject.toml (Single Source of Truth)
echo
if [[ -f "pyproject.toml" ]]; then
    echo "ðŸ Setting up Python environment from pyproject.toml..."
    uv venv
    uv sync  # Single source: pyproject.toml
    echo -e "${GREEN}âœ…${NC} Python environment ready"
else
    echo "ðŸ No pyproject.toml found, skipping Python setup."
fi

# Configure PYO3_PYTHON for cargo build (RSGI/Granian native worker support)
# This ensures PyO3 links against the SAME Python that uv uses at runtime
echo
if [[ -f "pyproject.toml" ]]; then
    echo "ðŸ”— Configuring PyO3 Python..."
    # Use uv's standalone Python (not venv) for consistent builtin modules
    UV_PYTHON=$(uv python find)
    if [ -n "$UV_PYTHON" ] && [ -x "$UV_PYTHON" ]; then
        # Write to .cargo/config.toml for persistent build-time configuration
        mkdir -p .cargo
        cat > .cargo/config.toml << EOF
# Auto-generated by setup-dev.sh - DO NOT EDIT
# This ensures PyO3 uses uv's Python for consistent builtin modules
[env]
PYO3_PYTHON = "$UV_PYTHON"
EOF
        echo -e "${GREEN}âœ…${NC} PYO3_PYTHON auto-configured: $UV_PYTHON"
    else
        echo -e "${YELLOW}âš ï¸${NC} Could not detect uv Python, using default"
    fi
else
    echo "ðŸ”— Skipping PYO3 configuration (no pyproject.toml)"
fi

# Install pre-commit hooks
echo
echo "ðŸ”— Installing pre-commit hooks..."
git config core.hooksPath .githooks
echo -e "${GREEN}âœ…${NC} Pre-commit hooks installed"

# Configure safe merge strategy (prevent accidental merge commits)
echo
echo "ðŸ›¡ï¸  Configuring safe merge strategy..."
git config pull.ff only
echo -e "${GREEN}âœ…${NC} pull.ff=only (safe merge) configured"

echo
echo "=========================================="
echo -e "${GREEN}âœ¨ Setup complete! You're ready to develop.${NC}"
echo
echo "Quick commands:"
echo "  cargo build --release     # Build"
echo "  cargo test                # Rust tests"
echo "  uv run pytest             # Python tests"
echo "  cargo clippy              # Lint"
echo "=========================================="
