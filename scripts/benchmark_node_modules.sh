#!/bin/bash
# Zero-Copy Ingest Benchmark: Real-World node_modules Test
# 
# Tests RFC-0039 zero-copy ingest with a ~140K file node_modules directory.
# Measures: file count, total size, ingest time, throughput.
#
# Usage:
#   ./scripts/benchmark_node_modules.sh              # Full run (npm install + ingest)
#   ./scripts/benchmark_node_modules.sh --skip-install  # Reuse existing node_modules
#
# Requirements:
#   - npm (for installing dependencies)
#   - cargo (for building vrift-cli)
#
# Results (Jan 2026, M1 MacBook Pro):
#   Files:       139,587
#   Size:        995 MB
#   Time:        54 seconds
#   Throughput:  ~2,585 files/sec

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DEMO_DIR="/tmp/vrift-demo"
PACKAGE_JSON="$PROJECT_ROOT/examples/velo-rift-node_modules_package.json"

# Parse arguments
SKIP_INSTALL=false
if [[ "${1:-}" == "--skip-install" ]]; then
    SKIP_INSTALL=true
fi

echo "=== Zero-Copy Ingest Benchmark: node_modules ==="
echo ""

# Step 1: Setup
if [[ "$SKIP_INSTALL" == "true" ]] && [[ -d "$DEMO_DIR/node_modules" ]]; then
    echo "[1/4] Reusing existing node_modules (--skip-install)"
else
    echo "[1/4] Setting up demo directory..."
    rm -rf "$DEMO_DIR"
    mkdir -p "$DEMO_DIR"
    cp "$PACKAGE_JSON" "$DEMO_DIR/package.json"
fi

# Step 2: Install dependencies
if [[ "$SKIP_INSTALL" == "true" ]] && [[ -d "$DEMO_DIR/node_modules" ]]; then
    echo "[2/4] Skipping npm install (--skip-install)"
else
    echo "[2/4] Installing npm dependencies (this may take a few minutes)..."
    cd "$DEMO_DIR"
    npm install --legacy-peer-deps --silent 2>/dev/null || true
    
    # Remove Chromium (has special permissions that cause issues)
    rm -rf "$DEMO_DIR/node_modules/puppeteer/.local-chromium" 2>/dev/null || true
fi

# Count files
FILE_COUNT=$(find "$DEMO_DIR/node_modules" -type f | wc -l | tr -d ' ')
DIR_SIZE=$(du -sh "$DEMO_DIR/node_modules" | cut -f1)
echo "   Files: $FILE_COUNT"
echo "   Size:  $DIR_SIZE"

# Step 3: Build vrift-cli
echo "[3/4] Building vrift-cli (release)..."
cd "$PROJECT_ROOT"
cargo build -p vrift-cli --release --quiet

# Step 4: Run ingest benchmark
echo "[4/4] Running zero-copy ingest..."
echo ""

# Clean previous .vrift directory
rm -rf "$DEMO_DIR/node_modules/.vrift"

# Time the ingest
START=$(date +%s.%N)
"$PROJECT_ROOT/target/release/vrift" ingest "$DEMO_DIR/node_modules" \
    --mode solid \
    --tier tier2 \
    -o "$DEMO_DIR/node_modules.manifest" 2>&1 | grep -E "^(Zero-Copy|CAS|Ingesting|✓|  )"

END=$(date +%s.%N)
ELAPSED=$(echo "$END - $START" | bc)

# Verify hard links
echo ""
echo "=== Verification ==="
SAMPLE_FILE="$DEMO_DIR/node_modules/lodash/package.json"
if [ -f "$SAMPLE_FILE" ]; then
    LINK_COUNT=$(stat -f "%l" "$SAMPLE_FILE" 2>/dev/null || stat -c "%h" "$SAMPLE_FILE" 2>/dev/null)
    if [ "$LINK_COUNT" -gt 1 ]; then
        echo "✓ Hard link verified (link count: $LINK_COUNT)"
    else
        echo "✗ Hard link NOT created (link count: $LINK_COUNT)"
    fi
fi

# Check LMDB manifest
if [ -d "$DEMO_DIR/node_modules/.vrift/manifest.lmdb" ]; then
    echo "✓ LMDB manifest created"
else
    echo "✗ LMDB manifest NOT found"
fi

# Summary
echo ""
echo "=== Summary ==="
echo "Files:      $FILE_COUNT"
echo "Size:       $DIR_SIZE"
echo "Time:       ${ELAPSED}s"
# Use awk for floating-point division (bc can't handle 0s)
THROUGHPUT=$(awk "BEGIN {printf \"%.0f\", $FILE_COUNT / ($ELAPSED + 0.001)}")
echo "Throughput: ~$THROUGHPUT files/sec"
echo ""
echo "Benchmark complete!"
echo ""
echo "=== Tips ==="
echo "Test data location: $DEMO_DIR/node_modules"
echo "To re-run without npm install: ./scripts/benchmark_node_modules.sh --skip-install"
echo "To clean up: rm -rf $DEMO_DIR"
