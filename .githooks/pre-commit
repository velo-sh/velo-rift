#!/bin/bash
# =============================================================================
# VRift Pre-commit Hook (Synced with Velo CI Pattern)
# =============================================================================
# Auto-format and auto-fix safe issues before commit.
# =============================================================================

set -e

echo "ğŸ¨ Auto-formatting with cargo fmt..."
cargo fmt

echo "ğŸ”§ Auto-fixing clippy (machine-applicable only)..."
# --fix: auto-apply fixes, --allow-staged: work on staged files
# --allow-dirty: don't fail if there are unstaged changes
# Only apply machine-applicable fixes (safe, no semantic changes)
cargo clippy --fix --allow-staged --allow-dirty --workspace --exclude vrift-fuse --exclude vrift-shim --all-targets || true

echo "ğŸ” Running cargo clippy check..."
cargo clippy --workspace --exclude vrift-fuse --exclude vrift-shim --all-targets -- -D warnings || {
    echo "âŒ Clippy check failed. Some warnings cannot be auto-fixed."
    exit 1
}

echo "ğŸ“ Re-staging auto-fixed files..."
git add -u

echo "ğŸ Auto-fixing Python (Ruff)..."
# Safe auto-fixes only (no semantic changes)
uv run ruff check --fix tests/ scripts/ || true
uv run ruff format tests/ scripts/ || true

echo "ğŸ“ Re-staging Python auto-fixed files..."
git add -u

echo "ğŸ” Running Full Pre-Commit Framework..."
# Final validation: mypy, remaining lint errors
if command -v pre-commit &>/dev/null; then
    pre-commit run --all-files || {
        echo "âŒ Pre-commit framework failed. Fix the issues above."
        exit 1
    }
fi

echo "âœ… All pre-commit checks passed!"
