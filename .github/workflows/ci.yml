name: CI

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
  pull_request:
    branches: [ "main" ]

# Cancel in-progress runs on same ref
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  VELO_ENV: ci

jobs:
  # ============================================
  # Fast Checks (Parallel) - Fail Fast
  # ============================================
  
  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-clippy"
      - name: Run Clippy
        run: source scripts/ci-common.sh && run_clippy

  # ============================================
  # Build (Required for Test Matrix)
  # ============================================
  
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
          cache-on-failure: true
      - name: Build Release
        run: cargo build --release -p vrift-cli
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: vrift-binary
          path: target/release/vrift
          if-no-files-found: error
          retention-days: 1

  # ============================================
  # Rust Test Matrix (Parallel) - Fail Fast
  # ============================================
  
  test-matrix:
    name: "Test: ${{ matrix.crate }}"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: true
      matrix:
        crate:
          - vrift-cas
          - vrift-manifest
          - vrift-lock
          - vrift-config
          - vrift-runtime
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@nextest
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-test-${{ matrix.crate }}"
      - name: "Test: ${{ matrix.crate }}"
        run: |
          # Run tests for library crates only (vrift-shim/fuse are platform-specific)
          cargo nextest run -p ${{ matrix.crate }}

  # ============================================
  # E2E Tests (After Build)
  # ============================================
  
  e2e-gc:
    name: "E2E: GC Test"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: vrift-binary
          path: target/release
      - name: Make executable
        run: chmod +x target/release/vrift
      - name: Run GC E2E Test
        run: python3 scripts/gc_e2e_test.py

  e2e-daemon:
    name: "E2E: Integration Test"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev sqlite3
      - name: Build with FUSE
        run: cargo build --release -p vrift-cli --features vrift-cli/fuse
      - name: Run Daemon E2E Test
        run: ./scripts/v-integration.sh

  e2e-extended:
    name: "E2E: Extended Tests (Demos)"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y sqlite3
      - name: Build Release
        run: cargo build --release -p vrift-cli
      - name: Run Tier 2 Demos
        run: ./scripts/v-ci --tier 2 --local

  # ============================================
  # Summary Gate (All Must Pass)
  # ============================================
  
  ci-success:
    name: CI Success
    if: always()
    needs: [fmt, clippy, build, test-matrix, e2e-gc, e2e-daemon, e2e-extended]
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.test-matrix.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-gc.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-daemon.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-extended.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "âœ… All CI checks passed!"
