name: CI

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
  pull_request:
    branches: [ "main" ]

# Cancel in-progress runs on same ref
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  VELO_ENV: ci

jobs:
  # ============================================
  # Fast Checks (Parallel) - Fail Fast
  # ============================================
  
  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-clippy"
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev fuse3
      - name: Run Clippy
        run: source scripts/ci-common.sh && run_clippy

  # ============================================
  # Build (Required for Test Matrix)
  # ============================================
  
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
          cache-on-failure: true
      - name: Build Release
        run: cargo build --release -p vrift-cli
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: vrift-binary
          path: target/release/vrift
          if-no-files-found: error
          retention-days: 1

  # ============================================
  # Rust Test Matrix (Parallel) - Fail Fast
  # ============================================
  
  test-matrix:
    name: "Test: ${{ matrix.crate }}"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: true
      matrix:
        crate:
          - vrift-cas
          - vrift-manifest
          - vrift-lock
          - vrift-config
          - vrift-runtime
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@nextest
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-test-${{ matrix.crate }}"
      - name: "Test: ${{ matrix.crate }}"
        run: |
          # Run tests for library crates only (vrift-shim/fuse are platform-specific)
          cargo nextest run -p ${{ matrix.crate }}

  # ============================================
  # Tiered CI Execution
  # ============================================
  
  tier-1:
    name: "Tier 1: Functional Integration"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev sqlite3
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Run Tier 1 Tests
        run: ./scripts/v-ci --tier 1 --local

  tier-2:
    name: "Tier 2: E2E & Demos"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev sqlite3
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Run Tier 2 Tests
        run: ./scripts/v-ci --tier 2 --local

  tier-3:
    name: "Tier 3: Benchmarks"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true # Benchmarks shouldn't block merge, but results are valuable
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev sqlite3
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Run Tier 3 Benchmarks
        run: ./scripts/v-ci --tier 3 --local

  tier-4:
    name: "Tier 4: Gap Analysis & Report"
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true # Report mode: Expected to have failures
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "vrift-build"
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libfuse3-dev sqlite3
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - name: Run Tier 4 Reports
        run: ./scripts/v-ci --tier 4 --local

  # ============================================
  # Summary Gate (All Must Pass)
  # ============================================
  
  ci-success:
    name: CI Success
    if: always()
    needs: [fmt, clippy, build, test-matrix, tier-1, tier-2, tier-3, tier-4]
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.test-matrix.result }}" != "success" ]] || \
             [[ "${{ needs.tier-1.result }}" != "success" ]] || \
             [[ "${{ needs.tier-2.result }}" != "success" ]]; then
            echo "One or more blocking jobs failed"
            exit 1
          fi
          
          # Tier 3 & 4 are non-blocking / informative
          echo "Tier 3 Result: ${{ needs.tier-3.result }}"
          echo "Tier 4 Result: ${{ needs.tier-4.result }}"

            echo "One or more jobs failed"
            exit 1
          fi
          echo "âœ… All CI checks passed!"
